[Unit]
Description=ucarp on <%= @is_external ? "external" : "gateway" %> VIPv4 %i
Requires=docker.service network.target
After=docker.service network.target

[Service]
Restart=always
RestartSec=60s
TimeoutStartSec=120
TimeoutStopSec=25

# See https://github.com/nicolerenee/docker-ucarp/blob/master/start.sh
# for how the environment variables ought to be set
# UCARP_VHID and UCARP_VIRTUALADDRESS are defined as Environment= stanzas
# in a supplemental, per-service systemd config file e.g.
# /etc/systemd/system/<%= @cluster_owner %>.gateway-ucarp-external@MYVIP.service.d/ip-and-vhid.conf
ExecStart=/usr/bin/docker run \
    --rm \
    --name=%p-<%= @title %>  \
    --net=host --cap-add NET_ADMIN \
    nicolerenee/ucarp \
      /usr/sbin/ucarp \
<%# From the ยง in ucarp/README that starts with "To understand how ucarp works,"
  # we see that --advbase acts as the "sticky" setting for the preferred
  # master:
  # -%>
      --advbase=<%= @is_preferred ? 1 : 2 %> \
      --interface=<%= @external_interface %> \
      --srcip=<%= @external_ipv4_address.split("/")[0] %> \
      --vhid=${UCARP_VHID} \
      --pass=${UCARP_PASS} \
      --addr=${UCARP_VIRTUALADDRESS} \
      --upscript=/etc/ucarp/vip-up-default.sh \
      --downscript=/etc/ucarp/vip-down-default.sh \
      --nomcast

ExecStop=/usr/bin/docker stop %p-%i

